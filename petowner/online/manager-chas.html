<!DOCTYPE html>
<html lang="en">

    <head>
        <title>LeashTime Manager Dashboard</title>

        <!-- BEGIN META -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="keywords" content="per_sitting_businesses">
        <meta name="description" content="PetOwner PetCare Management | Health & Wellness.  ">
        <!-- END META -->

        <!-- BEGIN FRAMEWORK STYLESHEETS -->
        <link href='http://fonts.googleapis.com/css?family=Roboto:300italic,400italic,300,400,500,700,900' rel='stylesheet' type='text/css' />
        <link type="text/css" rel="stylesheet" href="../../assets/css/theme-default/bootstrap.css?1422792965" />
        <link type="text/css" rel="stylesheet" href="../../assets/css/theme-default/materialadmin.css?1425466319" />
        <link type="text/css" rel="stylesheet" href="../../assets/css/theme-default/font-awesome.min.css?1422529194" />
        <link type="text/css" rel="stylesheet" href="../../assets/css/theme-default/material-design-iconic-font.min.css?1421434286" />

        <!-- BEGIN PLUGIN STYLESHEETS -->
        <link type="text/css" rel="stylesheet" href="../../assets/css/libs/fullcalendar/fullcalendar-leashtime.css">

        <!-- BEGIN LEASHTIME STYLESHEETS -->
        <link href="../../assets/css/leashtime-theme/colors.css" rel="stylesheet" type="text/css">
        <link href="../../assets/css/leashtime-theme/layout.css" rel="stylesheet" type="text/css">
        <link href="../../assets/css/leashtime-theme/lt-stlyes.css" rel="stylesheet" type="text/css">
        <link href="assets/css/petowner_portal.css" rel="stylesheet" type="text/css">
        <!-- END STYLESHEETS -->


        <script src='../../../modules/LT.js'></script>
        <script src='../../../modules/LTMGR.js'></script>
        <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.js'></script>
        <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v0.50.0/mapbox-gl.css' rel='stylesheet' />
        <style>

            #sitter {
                background-image: url('../../../images/sitter1.png');
                background-size: cover;
                width:  32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
            }
            #marker {
                background-image: url('../../../images/dog-marker.png');
                background-size: cover;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
            }
            #marker-arrived {
                    background-image: url('../../../images/arrive.png');
                    background-size: cover;
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    cursor: pointer;
            }
            #marker1 {
                    background-image: url('../../../images/sitter1.png');
                    background-size: cover;
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    cursor: pointer;
            }
            #marker2 {
                    background-image: url('../../../images/sitter2.png');
                    background-size: cover;
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    cursor: pointer;
            }
            #marker3{
                    background-image: url('../../../images/sitter3.png');
                    background-size: cover;
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    cursor: pointer;
            }
            #marker4{
                    background-image: url('../../../images/sitter4.png');
                    background-size: cover;
                    width: 32px;
                    height: 32px;
                    border-radius: 50%;
                    cursor: pointer;
            }
            #marker-future {
                background-image: url('../../../images/dog-marker.png');
                background-size: cover;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
            }

            #marker-late {
                background-image: url('../../../images/yellow-flag-begin@3x.png');
                background-size: cover;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
            }

            #marker-complete {
                background-image: url('../../../images/check-mark-green@3x.png');
                background-size: cover;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
            }

            #marker-canceled {
                background-image: url('../../../images/red-dot@3x.png');
                background-size: cover;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
            }

            #marker-visitreport {
                background-image: url('../../../images/note-icon@3x.png');
                background-size: cover;
                width: 32px;
                height: 32px;
                border-radius: 50%;
                cursor: pointer;
            }

            .mapboxgl-popup {
                max-width: 400px;
            }

            .button {
                display: inline-block;
                border: none;
                padding: 1rem 2rem;
                margin: 0;
                text-decoration: none;
                background: #0069ed;
                color: #000000;
                font-family: sans-serif;
                font-size: 1rem;
                cursor: pointer;
                text-align: center;
                transition: background 250ms ease-in-out,
                    transform 150ms ease;
                -webkit-appearance: none;
                -moz-appearance: none;
            }
            li {
                list-style: none;
            }
        </style>

    </head>


    <body class="header-fixed">

        <!--/////////////// BEGIN HEADER ///////////////-->
        <header id="header">
            <div class="headerbar blue">
                <!-- HEADER BRANDING -->
                <div class="headerbar-left hidden-on-mobile">
                    <ul class="header-nav header-nav-options">
                        <li style="float: left;">
                            <a class="btn btn-icon-toggle text-center" data-toggle="menubar" href="javascript:void(0);">
                                <i class=" fa fa-paw white-text fa-2x"></i>
                            </a>
                        </li>
                        <li style="line-height:1;padding:24px 0">
                            <div class="brand-holder">
                                    <span class="text-lg white-text " style="margin:0;padding-left: 12px">CARE<strong> MANAGER</strong>â„¢
                                    <span style="font-weight: 100;opacity: .8">  |  SITTER OPERATION</span>
                                    <span>
                                        <input type="text" value="dlife" id="userName" name="username" style="color:black; background-color:white; border: solid 1px #6E6E6E; height: 30px; font-size:18px; vertical-align:9px"></input>
                                        <input type="text" value="pass" id="passWord" name="password" style="color:#000000; background-color:white; border: solid 1px #6E6E6E; height: 30px; font-size:18px; vertical-align:9px"></intpu>
                                        <button type = "button" style="background-color:lightgreen" id="login" class=class="btn btn-block transparent"  onClick=login()>LOGIN</button>
                                    </span>
                                    <span>
                                        <label id="dayWeek"></label>
                                        <label id="month">M</label>
                                        <label id="dateLabel">DT</label>
                                        <button type = "button" style="background-color:orange" id="login" class=class="btn btn-block transparent"  onClick=prevDay()>PREV</button>
                                         <button type = "button" style="background-color:blue" id="login" class=class="btn btn-block transparent"  onClick=nextDay()>NEXT</button>
                                    </span>

                            </div>
                        </li>
                    </ul>

                </div>
                <!-- HEADER MENU -->
                <div class="headerbar-right">
                    <!-- START NAV DROP -->
                    <div class="headerbar-right">
                        <!-- MAIN MENU -->

                    </div>
                    <!--end #header-navbar-collapse -->

                </div>
            </div>
        </header>
        <!-- END HEADER NAV-->

        <!-- BEGIN OFFCANVAS HOLDER LEFT -->
        <div class="offcanvas"></div>
        <!-- END OFFCANVAS HOLDER LEFT -->

        <!-- ////////////////// BEGIN MAIN CONTENT  ////////////////////-->
        <div id="content">
            <!-- BEGIN BASIC MAP -->
            <div class="row">
                <div class="col-sm-2 small-padding no-margin">
                    <div id="sitterList" class="sitterListView full-bleed styled-info"></div>
                </div>

                <div class="col-sm-8 full-bleed no-padding no-margin" style="height: 900px">
                    <div class="card transparent no-margin no-padding">
                        <div id='map' class="mapView border-gray" style="height: 900px"></div>
                    </div>
                    <div id="filterOptions" class="filterStatus ">
                        <div class="btn-group btn-group-justified" role="group" aria-label="Justified button group">
                            <a class="btn btn-default-bright" role="button"><input type="checkbox" class="filterStatus btn btn-default-bright" id="late" onclick="filterMapViewByVisitStatus('late')" role="button" checked>Late</a>
                            <a class="btn btn-default-bright" role="button"><input type="checkbox" class="filterStatus" id="incomplete" onclick="filterMapViewByVisitStatus('future')" checked>Incomplete</a>
                            <a class="btn btn-default-bright" role="button"><input type="checkbox" class="filterStatus" id="completed" onclick="filterMapViewByVisitStatus('completed')" checked>Completed</a>
                            <a class="btn btn-default-bright" role="button"><input type="checkbox" class="filterStatus" id="visitreport" onclick="filterMapViewByVisitStatus('visitreport')" checked>Visit Report</a>
                            <a class="btn btn-default-bright" role="button"><input type="checkbox" class="filterStatus" id="canceled" onclick="filterMapViewByVisitStatus('canceled')" checked>Canceled</a>
                        </div>
                    </div>
                </div>


                <div class="col-sm-2 full-bleed small-padding no-margin">
                    <div id="visitListByClient" class="visitListViewSitterClient">
                        

                    </div>
                </div>
            </div>
        </div>
    <script>
       
        const delay = 3000;
        var allVisits = [];
        var allSitters= [];
        var allClients =[];
        var visitsBySitter =  {};
        var petImages = []
        var mapMarkers = [];
        var statusVisit = {
            'future' : 'on',
            'late' : 'on',
            'canceled' : 'on',
            'completed' : 'on',
            'visitreport' : 'on',
            'arrived' : 'on'
        };

        var speedFactor = 30; // number of frames per longitude degree
        var animation; // to store and cancel the animation
        var startTime = 0;
        var progress = 0; // progress = timestamp - startTime
        var resetTime = false; // indicator of whether time reset is needed for the animation
        var sitterIcons = ["marker1", "marker2","marker3","marker4"];
        const  dayArrStr = ['SUN','MON','TUE','WED','THU','FRI','SAT'];
        const monthsArrStr = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
       
        mapboxgl.accessToken = 'pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw';

        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v9',
            center : ([-77.888,38.1111]),
            zoom: 9
        });

        var geoData = {
                "type": "FeatureCollection",
                "features": [
                                        {
                                            "type": "Feature",
                                            "geometry": {
                                                "type": "LineString",
                                                "coordinates": [

                                                    [0,0]

                                                ]
                                            }
                                        }
                                    ]
            };

        var polyVar = {
                'id': 'maine',
                'type': 'fill',
                'source': {
                    'type': 'geojson',
                    'data': {
                        'type': 'Feature',
                        'geometry': {
                            'type': 'Polygon',
                            'coordinates': [
                                [
                                    /*[-67.13734351262877, 45.137451890638886],
                                    [-66.96466, 44.8097],
                                    [-68.03252, 44.3252],
                                    [-69.06, 43.98],
                                    [-70.11617, 43.68405],
                                    [-70.64573401557249, 43.090083319667144],
                                    [-70.75102474636725, 43.08003225358635],
                                    [-70.79761105007827, 43.21973948828747],
                                    [-70.98176001655037, 43.36789581966826],
                                    [-70.94416541205806, 43.46633942318431],
                                    [-71.08482, 45.3052400000002],
                                    [-70.6600225491012, 45.46022288673396],
                                    [-70.30495378282376, 45.914794623389355],
                                    [-70.00014034695016, 46.69317088478567],
                                    [-69.23708614772835, 47.44777598732787],
                                    [-68.90478084987546, 47.184794623394396],
                                    [-68.23430497910454, 47.35462921812177],
                                    [-67.79035274928509, 47.066248887716995],
                                    [-67.79141211614706, 45.702585354182816],
                                    [-67.13734351262877, 45.137451890638886]*/
                                ]
                            ]
                        }
                    }
                },
                'layout': {},
                'paint': {
                    'fill-color': '#088',
                    'fill-opacity': 0.8
                }
            }


        map.on("load",()=>{
            map.addLayer({
                'id': 'line-animation',
                'type': 'line',
                'source': {
                    'type': 'geojson',
                    'data': geoData
                },
                'layout': {
                    'line-cap': 'round',
                    'line-join': 'round'
                },
                'paint': {
                    'line-color': '#ed6498',
                    'line-width': 5,
                    'line-opacity': .8
                }
            });
        });

        function login() {

            console.log('Logging in - cleaning up');
            removeSittersFromSitterList();
            removeAllMapMarkers();
            removeVisitDivElements();

            console.log('Logging in - emptying variables');

            allVisits = [];
            allSitters = [];
            allClients =[];
            visitsBySitter = [];
            mapMarkers = [];

            let username = document.getElementById('userName').value;
            let password = document.getElementById('passWord').value;
            let usernameNode = document.getElementById('userName');
            usernameNode.parentNode.removeChild(usernameNode);
            let passwordNode = document.getElementById('passWord')
            passwordNode.parentNode.removeChild(passwordNode);
            document.getElementById('login').innerHTML = 'UDATE';
            var userRole = 'm';

            var fullDate = getFullDate();
            var todayDateLocal = new Date();

            let loginPromise = new Promise(function(resolve, reject) {
                console.log('Logging in with: ' + username + ' and ' + password);
                let url = 'http://localhost:3300?type=mmdLogin&username='+username+'&password='+password+'&role='+userRole+'&startDate='+fullDate+'&endDate='+fullDate;
                fetch(url)
                    .then((response)=> {
                        console.log('Fetch response');
                        return response.json();
                    })
                    .then((managerJSON)=> {
                        let keys = Object.keys(managerJSON);
                        if (managerJSON.managerData == 'ok') {
                            console.log('MANAGER DATA OK');
                        }
                        resolve('ok');
                    });
            });

            loginPromise.then(function(done) {
                console.log('Promise done');
                LTMGR.getManagerData();
                LTMGR.getManagerVisits();
                LTMGR.getManagerClients();
                console.log(done);
                return done;
            })
            .then(function(done) {

                console.log('SECOND DONE ON REQUESTS');
                var sitterNameVisits  = setInterval(()=> {
                    console.log('GETTING FINISHED VISITS: ');
                    allVisits = LTMGR.getVisitList();
                    allSitters = LTMGR.getSitters();
                    allClients = LTMGR.getClientList();

                    flyToFirstVisit();
                    buildSitterButtons(allVisits, allSitters);
                    clearInterval(sitterNameVisits);
  
                }, 1000);
                return(done);
            });          
        }
        function flyToFirstVisit() {
            if (allVisits[0] != null) {
                 let lastVisit = allVisits[0];
                if (lastVisit.lon != null && lastVisit.lat != null) {
                    map.flyTo({
                        center: [lastVisit.lon, lastVisit.lat],
                        zoom: 16
                    });
                } else {
                    console.log('invalid lat or lon coordinate')
                }
            }
        }
        function getFullDate() {
            var todayDate = new Date();
            let todayMonth = todayDate.getMonth()+1;
            let todayYear = todayDate.getFullYear();
            let todayDay = todayDate.getDate();

            let dayOfWeek = todayDate.getDay();

            let dayWeekLabel = document.getElementById('dayWeek');
            dayWeekLabel.innerHTML = dayArrStr[dayOfWeek] + ', ';
            let monthLabel = document.getElementById('month');
            monthLabel.innerHTML = monthsArrStr[todayMonth-1];
            let dateLabel = document.getElementById("dateLabel");
            dateLabel.innerHTML = todayDay;
            return todayYear+'-'+todayMonth+'-'+todayDay;
        }
        function prevDay() {
        }
        function nextDay() {
        }
        function buildSitterButtons(allSitterVisits, allSittersInfo) {
            allSittersInfo.forEach((sitter)=> {
                let hasVisits = false;
                let sitterCount = parseInt(0);

                allSitterVisits.forEach((visitDetails)=> {
                    if (sitter.sitterID == visitDetails.sitterID) {
                        hasVisits = true;
                        createMapMarker(visitDetails, sitterIcons[sitterCount]);
                        sitterCount = sitterCount + 1;
                    }
                });

                if (hasVisits) {
                    createSitterMapMarker(sitter);
                    let sitterListDiv = document.getElementById("sitterList");
                    let sitterFilterButton = document.createElement("button");
                    sitterFilterButton.setAttribute("type", "button");
                    sitterFilterButton.setAttribute("id", sitter.sitterID);
                    sitterFilterButton.setAttribute("class", "btn btn-black transparent");
                    let spanEl = document.createElement("span");
                    spanEl.setAttribute("class", "pull-left");
                    sitterFilterButton.appendChild(spanEl);
                    sitterFilterButton.innerHTML = sitter.sitterName + ' (' + sitterCount + ')';
                    sitterListDiv.appendChild(sitterFilterButton);
                    document.getElementById(sitter.sitterID).addEventListener("click", removeVisitDivElements);  
                    document.getElementById(sitter.sitterID).addEventListener("click", removeAllMapMarkers);
                    document.getElementById(sitter.sitterID).addEventListener("click",function() {showVisitBySitter(sitter.sitterID);});
                    visitsBySitter[sitter.sitterID] = sitterCount;
                }
            });
        }

        function drawSitterRoutes(sitterID) {
            console.log('sitter map marker clicked. checking visit with count: ' + allVisits.length + ' SITTER ID: ' + sitterID);
            let arraySitterVisits = [];
            let polygonArray = [];
            let sitID = parseInt(sitterID);

            removeAllMapMarkers();
            let coordCounter = 0;

            allVisits.forEach((visitDetailsSitter) => {

                let visitid = parseInt(visitDetailsSitter.sitterID);


                if (sitID == visitid) {
                    let lat = parseFloat(visitDetailsSitter.lat);
                    let lon = parseFloat(visitDetailsSitter.lon);
                    polyVar.source.data.geometry.coordinates[0].push([lat,lon]);
                    //console.log(polyVar.source.data.geometry.coordinates[0][coordCounter]);
                    coordCounter = coordCounter + 1;
                    arraySitterVisits.push(visitDetailsSitter);
                }
            });  

            let numVisits = arraySitterVisits.length;
            /*console.log('Number of visits: ' + numVisits);
            const urls = ['a', 'b', 'c'];
            var funcs = [];
            arraySitterVisits.forEach((visit) => {
                console.log('adding function to funcs');
                funcs.push(function() {
                    let lat = visit.lat;
                    let lon = visit.lon;

                    map.flyTo({
                        center: [lon, lat],
                        zoom: 16
                    });
                })
            });*/
           

            showVisitBySitter(sitterID);

            
                //var flyToVisit  = setInterval(()=> {
                let timerId = setTimeout(function fly() {
                   let visitCoord = arraySitterVisits[numVisits-1];
                    let lat = parseFloat(visitCoord.lat);
                    let lon = parseFloat(visitCoord.lon);
                    console.log('Flying to visit: ', lat + ' ' + lon) ;
                    map.flyTo({
                                center: [lon, lat],
                                zoom: 16
                    });
                    numVisits = numVisits -1;
                    if (numVisits > 0) {
                        timerId=setTimeout(fly, 2000);
                    }
                }, 2000);   
                

               
        
            /*const promiseSerial = funcs =>
                funcs.reduce((promise, func) =>
                    promise.then(result => func()
                                .then(()=> {
                                    Array.prototype.concat.bind(result)
                                }
                                    )
                                ),
                        Promise.resolve([]));

            
            promiseSerial(funcs)
              .then(console.log.bind(console))
              .catch(console.error.bind(console));*/
                
               
            
            //startTime = performance.now();
            //animateLine();
        }
        function animateLine(timestamp) {
            if (resetTime) {
                // resume previous progress
                startTime = performance.now() - progress;
                resetTime = false;
            } else {
                progress = timestamp - startTime;
            }

            // restart if it finishes a loop
            if (progress > speedFactor * 360) {
                startTime = timestamp;
                geojson.features[0].geometry.coordinates = [];
            } else {
                var x = progress / speedFactor;
                // draw a sine wave with some math.
                var y = Math.sin(x * Math.PI / 90) * 40;
                // append new coordinates to the lineString
                geojson.features[0].geometry.coordinates.push([x, y]);
                // then update the map
                map.getSource('line-animation').setData(geojson);
            }
            // Request the next frame of the animation.
            animation = requestAnimationFrame(animateLine);
        }
        function createSitterPopup(sitterInfo) {

            let popupBasicInfo = '<h1>'+sitterInfo.sitterName+'</h1>';
            var listClients = LTMGR.getClientList();

            popupBasicInfo += '<p>'+sitterInfo.street1 +'</p>';
            popupBasicInfo += '<p>'+sitterInfo.city+'</p>';
            popupBasicInfo += '<p>Number of visits</p>';

            popupBasicInfo += '<p><img src=\"../../../images/messagebubble128x128@3x.png\" width=20 height=20>&nbsp&nbsp<input type=\"text\" name=\"messageSitter\" id=\"messageSitter\"></p>';

            popupBasicInfo += '<button id='+sitterInfo.sitterID+' class=\"button\" onclick=drawSitterRoutes('+sitterInfo.sitterID+')>Draw Routes</button>';

           

            return popupBasicInfo;
        }
        function createSitterMapMarker(sitterInfo) {
            let el = document.createElement('div');
            let latitude = parseFloat(sitterInfo.sitterLat);
            let longitude = parseFloat(sitterInfo.sitterLon);
            let popupView;
            if (latitude != null && longitude != null && latitude < 90 && latitude > -90) {
                popupView = createSitterPopup(sitterInfo);
                el.class = 'sitter';
                el.id = 'sitter';

                let popup = new mapboxgl.Popup({offset : 25})
                    .setHTML(popupView);

                if (latitude > 90 || latitude < -90 ) {
                    console.log("Lat error");
                } else {
                    let marker = new mapboxgl.Marker(el)
                        .setLngLat([longitude,latitude])
                        .setPopup(popup)
                        .addTo(map);

                        
                    mapMarkers.push(marker);
                }
            }
        }
        function createMapMarker(visitInfo, markerIcon) {

            let el = document.createElement('div');
            let latitude = parseFloat(visitInfo.lat);
            let longitude = parseFloat(visitInfo.lon);
            let popupView;
            if (latitude != null && longitude != null && latitude < 90 && latitude > -90) {
                popupView = createPopupView(visitInfo);
                el.class = 'mapMarker';
                
                if (visitInfo.status == 'completed') {
                    el.id = 'marker-complete';
                } else if (visitInfo.status == 'canceled') {
                    el.class = 'style=error';
                } else if (visitInfo.status == 'late') {
                    el.id = 'marker-late';
                } else if (visitInfo.status == 'arrived') {
                    el.id = 'marker-arrived'
                } else if (visitInfo.status == 'future' || visitInfo.status == 'incomplete') {
                    el.id = 'marker';
                }

                let popup = new mapboxgl.Popup({offset : 25})
                    .setHTML(popupView);

                if (latitude > 90 || latitude < -90 ) {
                    console.log("Lat error");
                } else {
                    let marker = new mapboxgl.Marker(el)
                        .setLngLat([longitude,latitude])
                        .setPopup(popup)
                        .addTo(map);

                    mapMarkers.push(marker);
                }
            }
        }
        function createPopupView(visitInfo, divElement) {

            let popupBasicInfo = '<h1>'+visitInfo.pets+'</h1>';
            var listClients = LTMGR.getClientList();

            listClients.forEach((client) => {
                if(visitInfo.clientID == client.client_id) {
                    popupBasicInfo += '<div class=\"petProfilePhotos\" id=\"' + client.client_id + '\">';
                    let petCount = 0;
                    client.pets.forEach((pet)=> {
                        let url = '<img src=\"../../../images/dog'+petCount+ '.jpg\" id=\"petPhoto\" width=100 height=100 onopen=fetchPetPhoto()>&nbsp&nbsp';
                        let imageComponent = url;
                        popupBasicInfo += imageComponent;
                        petCount = petCount + 1;
                    });

                    popupBasicInfo += '</div>';
                    if (client.street2 != null) {
                        popupBasicInfo += '<p>' + client.street1 + ', ' +client.street2;
                    } else {
                        popupBasicInfo += '<p>' + client.street1
                    }

                }
            });

            popupBasicInfo += '<p>'+visitInfo.sitterName +'</p>';
            popupBasicInfo += '<p>'+visitInfo.clientName+'</p>';
            popupBasicInfo += '<p>'+visitInfo.service+'</p>';
            
            if (visitInfo.status == 'completed') {
                popupBasicInfo += '<p><img src=\"../../../images/check-mark-green@3x.png\" width=20 height=20>'+visitInfo.timeOfDay+'</p>';
                popupBasicInfo += '<p>Started: ' + visitInfo.starttime + ' - ' + visitInfo.endtime + '</p>';
            } else if (visitInfo.status == 'late') {
                popupBasicInfo += '<p><img src=\"../../../images/yellow-flag-begin@3x.png\" width=20 height=20>'+visitInfo.timeOfDay+'</p>';
            } else if (visitInfo.status == 'future') {
                popupBasicInfo += '<p><img src=\"../../../images/clockicon@3x.png\" width=20 height=20>'+visitInfo.timeOfDay+'</p>';
            } else if (visitInfo.status == 'canceled') {
                popupBasicInfo += '<p><img src=\"../../../images/x-mark-red@3x.png\" width=20 height=20>'+visitInfo.timeOfDay+'</p>';
            }

            if (visitInfo.visitNote != null) {
                popupBasicInfo += "<p><img src=\"../../../images/postit\-20x20.png\" width=20 height=20>"+visitInfo.visitNote;
            }

            popupBasicInfo += '<p><img src=\"../../../images/messagebubble128x128@3x.png\" width=20 height=20>&nbsp&nbsp<input type=\"text\" name=\"messageSitter\" id=\"messageSitter\"></p>';

            return popupBasicInfo;
        }
        function filterMapViewByVisitStatus(filterStatus) {

            if (statusVisit[filterStatus] == 'on') {
                statusVisit[filterStatus] =  'off';
            } else {
                statusVisit[filterStatus] = 'on';
            }

            let visitFilterArray = [];
            mapMarkers.forEach((marker)=>{
                marker.remove();
            });

            let allVisits = LTMGR.getVisitList();
            let statKeys = Object.keys(statusVisit);

            allVisits.forEach((visitDetails)=> {
                let visitStatus = visitDetails.status;
                console.log(visitStatus);
                if (statusVisit[visitStatus] == 'on' && visitDetails.status == visitStatus) {
                    visitFilterArray.push(visitDetails);
                }
            });
            visitFilterArray.forEach((visit) => {
                createMapMarker(visit,'marker');
            });
        }
        function showVisitBySitter(sitterID){

            removeVisitDivElements();
            removeAllMapMarkers();

            let visitListBySitter = [];

            allVisits.forEach((visitDetails)=> {
                if (visitDetails.sitterID == sitterID) {
                    visitListBySitter.push(visitDetails);
                    createVisitHTML(visitDetails);
                    createMapMarker(visitDetails,'marker');
                }
            });

            let lastVisit = visitListBySitter[visitListBySitter.length -1]

            map.flyTo({
                center: [parseFloat(lastVisit.lon), parseFloat(lastVisit.lat)],
                zoom: 18
            });
        }
        function removeVisitDivElements() {
            var element = document.getElementById("visitListByClient");
            while (element.firstChild) {
                element.removeChild(element.firstChild);
            }
        }
        function removeSittersFromSitterList() {

            var element = document.getElementById("sitterList");
            while (element.firstChild) {
                element.removeChild(element.firstChild);
            }
        }
        function removeAllMapMarkers() {
            mapMarkers.forEach((marker)=>{
                marker.remove();
            });
        }
        function createVisitHTML(visitDetails) {                        
            let visitDiv = document.getElementById("visitListByClient");
            let visitLabel = document.createElement('button')
            visitLabel.id = visitDetails.visitID;
            visitLabel.setAttribute("class", "btn btn-block");
            visitLabel.setAttribute("name", visitDetails.clientName);
            visitLabel.setAttribute("type", "button");
            let fLat = parseFloat(visitDetails.lat);
            let fLon = parseFloat(visitDetails.lon);
            visitLabel.addEventListener('click' , function() {
                console.log(fLat + ' ' + fLon);
                map.flyTo({
                    center: [fLon, fLat],
                    zoom: 18
                });
            });
            visitLabel.innerHTML = visitDetails.clientName;

            if(visitDetails.status == 'late') {
                visitLabel.style.backgroundColor = "yellow";
            } else if (visitDetails.status == "completed") {
                visitLabel.style.backgroundColor = "green";
            } else if (visitDetails.status == "canceled") {
                visitLabel.style.backgroundColor = "red";
            }
            visitDiv.appendChild(visitLabel);
        }


    </script>
</html>
